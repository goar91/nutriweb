<div class="page-shell">
  <header class="hero">
    <p class="eyebrow">NutriWeb · Historia clínica nutricional</p>
    <h1>{{ pageTitle() }}</h1>
    @if (isEditMode()) {
      <div class="edit-mode-banner">
        <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
          <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"/>
        </svg>
        <span>Modo Edición - Modificando datos existentes</span>
      </div>
    }
    <p>
      Registra los datos clínicos, hábitos y frecuencias alimentarias del paciente
      para que el equipo nutricional pueda preparar un plan personalizado.
    </p>
  </header>

  <form class="history-form" [formGroup]="nutriForm" (ngSubmit)="submitHistory()">
    <section class="card">
      <h2>Datos personales</h2>
      <div formGroupName="personalData" class="grid grid-3">
        <label>
          Nombre
          <input formControlName="nombre" type="text" placeholder="Nombre completo" />
        </label>
        <label>
          Edad cronológica
          <input formControlName="edadCronologica" type="text" placeholder="Años" />
        </label>
        <label>
          Sexo
          <input formControlName="sexo" type="text" placeholder="F / M" />
        </label>
        <label>
          Lugar de residencia
          <input formControlName="lugarResidencia" type="text" />
        </label>
        <label>
          Estado civil
          <input formControlName="estadoCivil" type="text" />
        </label>
        <label>
          Número de cédula
          <input formControlName="numeroCedula" type="text" />
        </label>
        <label>
          Teléfono
          <input formControlName="telefono" type="tel" />
        </label>
        <label>
          Ocupación
          <input formControlName="ocupacion" type="text" />
        </label>
        <label>
          Email
          <input formControlName="email" type="email" />
        </label>
        <label>
          Fecha de consulta
          <input formControlName="fechaConsulta" type="date" />
        </label>
      </div>
    </section>

    @if (editType() === 'paciente') {
      <section class="card info-message">
        <div class="info-content">
          <svg width="24" height="24" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
          </svg>
          <div>
            <h3>Editando datos personales</h3>
            <p>Solo puedes modificar los datos personales del paciente. Para editar una historia clínica completa, usa el botón "Editar" en la historia clínica específica desde el dashboard.</p>
          </div>
        </div>
      </section>
    }

    <!-- Solo mostrar estas secciones cuando NO estamos editando solo el paciente -->
    @if (editType() !== 'paciente') {
    <section class="card">
      <h2>Motivo de consulta</h2>
      <label class="full">
        <textarea
          formControlName="motivoConsulta"
          rows="3"
          placeholder="Describe brevemente el motivo de la consulta"
        ></textarea>
      </label>
    </section>

    <section class="card">
      <h2>Antecedentes</h2>
      <div formGroupName="antecedentes" class="grid grid-3">
        <label>
          APF
          <input formControlName="apf" type="text" />
        </label>
        <label>
          APP
          <input formControlName="app" type="text" />
        </label>
        <label>
          APQ
          <input formControlName="apq" type="text" />
        </label>
        <label>
          AGO
          <input formControlName="ago" type="text" />
        </label>
        <label>
          Menarquía
          <input formControlName="menarquia" type="text" />
        </label>
        <label>
          P · G · C · A
          <input formControlName="p" placeholder="P" />
          <input formControlName="g" placeholder="G" />
          <input formControlName="c" placeholder="C" />
          <input formControlName="a" placeholder="A" />
        </label>
        <label>
          Alergias
          <input formControlName="alergias" type="text" />
        </label>
      </div>
    </section>

    <section class="card">
      <h2>Diagnóstico nutricional clínico</h2>
      <label class="full">
        <textarea formControlName="diagnostico" rows="3"></textarea>
      </label>
    </section>

    <section class="card">
      <h2>Hábitos del paciente</h2>
      <div formGroupName="habitos" class="grid grid-3">
        <label>
          Fuma
          <input formControlName="fuma" type="text" />
        </label>
        <label>
          Alcohol
          <input formControlName="alcohol" type="text" />
        </label>
        <label>
          Café
          <input formControlName="cafe" type="text" />
        </label>
        <label>
          Hidratación
          <input formControlName="hidratacion" type="text" />
        </label>
        <label>
          Gaseosas
          <input formControlName="gaseosas" type="text" />
        </label>
        <label>
          Actividad física
          <input formControlName="actividadFisica" type="text" />
        </label>
        <label>
          Té
          <input formControlName="te" type="text" />
        </label>
        <label>
          Uso de edulcorantes
          <input formControlName="edulcorantes" type="text" />
        </label>
        <label>
          Alimentación
          <input formControlName="alimentacion" type="text" />
        </label>
      </div>
    </section>

    <section class="card">
      <h2>Signos vitales</h2>
      <div formGroupName="signos" class="grid grid-4">
        <label>
          PA
          <input formControlName="pa" type="text" />
        </label>
        <label>
          Temperatura
          <input formControlName="temperatura" type="text" />
        </label>
        <label>
          FC
          <input formControlName="fc" type="text" />
        </label>
        <label>
          FR
          <input formControlName="fr" type="text" />
        </label>
      </div>
    </section>

    <section class="card">
      <h2>Datos antropométricos</h2>
      <div formGroupName="antropometricos" class="grid grid-4">
        <label>
          Edad
          <input formControlName="edad" type="text" />
        </label>
        <label>
          Edad metabólica
          <input formControlName="edadMetabolica" type="text" />
        </label>
        <label>
          Sexo
          <input formControlName="sexo" type="text" />
        </label>
        <label>
          Peso
          <input formControlName="peso" type="text" />
        </label>
        <label>
          Masa muscular
          <input formControlName="masaMuscular" type="text" />
        </label>
        <label>
          % GC
          <input formControlName="gcPorc" type="text" />
        </label>
        <label>
          GC
          <input formControlName="gc" type="text" />
        </label>
        <label>
          Talla
          <input formControlName="talla" type="text" />
        </label>
        <label>
          % GV
          <input formControlName="gvPorc" type="text" />
        </label>
        <label>
          IMC
          <input formControlName="imc" type="text" />
        </label>
        <label>
          KCAL basales
          <input formControlName="kcalBasales" type="text" />
        </label>
        <label>
          Cinta de actividad física
          <input formControlName="actividadFisica" type="text" />
        </label>
        <label>
          Cintura
          <input formControlName="cintura" type="text" />
        </label>
        <label>
          Cadera
          <input formControlName="cadera" type="text" />
        </label>
        <label>
          Pantorrilla
          <input formControlName="pantorrilla" type="text" />
        </label>
        <label>
          C. brazo
          <input formControlName="cBrazo" type="text" />
        </label>
        <label>
          C. muslo
          <input formControlName="cMuslo" type="text" />
        </label>
        <label>
          Peso ajustado
          <input formControlName="pesoAjustado" type="text" />
        </label>
        <label>
          Factor de actividad física
          <input formControlName="factorActividadFisica" type="text" />
        </label>
        <label>
          Tiempos de comida
          <input formControlName="tiemposComida" type="text" />
        </label>
      </div>
    </section>

    <section class="card">
      <h2>Valores bioquímicos</h2>
      <div formGroupName="valoresBioquimicos" class="grid grid-4">
        <label>
          Glicemia
          <input formControlName="glicemia" type="text" />
        </label>
        <label>
          Colesterol total
          <input formControlName="colesterolTotal" type="text" />
        </label>
        <label>
          Triglicéridos
          <input formControlName="trigliceridos" type="text" />
        </label>
        <label>
          HDL
          <input formControlName="hdl" type="text" />
        </label>
        <label>
          LDL
          <input formControlName="ldl" type="text" />
        </label>
        <label>
          TGO
          <input formControlName="tgo" type="text" />
        </label>
        <label>
          TGP
          <input formControlName="tgp" type="text" />
        </label>
        <label>
          Urea
          <input formControlName="urea" type="text" />
        </label>
        <label>
          Creatinina
          <input formControlName="creatinina" type="text" />
        </label>
      </div>
    </section>

    <section class="card">
      <h2>Frecuencia de consumo de alimentos</h2>
      <div
        class="frequency-card"
        *ngFor="let category of foodCategories"
        [attr.data-title]="category.title"
      >
        <div class="frequency-header">
          <h3>{{ category.title }}</h3>
          <p>Selecciona la frecuencia que mejor describe el consumo habitual.</p>
        </div>
        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>Alimento</th>
                <th *ngFor="let option of supportedFrequencies">{{ option }}</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let food of category.items">
                <td>{{ food }}</td>
                <td *ngFor="let option of supportedFrequencies">
                  <label class="radio-cell">
                    <input
                      type="radio"
                      [attr.name]="frequencyKey(category.title, food)"
                      [value]="option"
                      [checked]="getFrequency(category.title, food) === option"
                      (change)="setFrequency(category.title, food, option)"
                    />
                    <span class="visually-hidden">{{ option }}</span>
                  </label>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <section class="card">
      <h2>Recordatorio de 24 h</h2>
      <div formGroupName="recordatorio24h" class="grid grid-2">
        <label>
          Desayuno
          <textarea formControlName="desayuno" rows="2"></textarea>
        </label>
        <label>
          Snack
          <textarea formControlName="snack1" rows="2"></textarea>
        </label>
        <label>
          Almuerzo
          <textarea formControlName="almuerzo" rows="2"></textarea>
        </label>
        <label>
          Snack
          <textarea formControlName="snack2" rows="2"></textarea>
        </label>
        <label>
          Cena / merienda
          <textarea formControlName="cena" rows="2"></textarea>
        </label>
        <label>
          Extras
          <textarea formControlName="extras" rows="2"></textarea>
        </label>
      </div>
    </section>

    <section class="card">
      <h2>Notas extras</h2>
      <label class="full">
        <textarea formControlName="notasExtras" rows="3" placeholder="Observaciones adicionales"></textarea>
      </label>
    </section>
    }
    <!-- Fin de secciones solo para historia clínica -->

    <div class="actions">
      <button type="submit" [disabled]="isSubmitting()">
        <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
        </svg>
        Guardar historia
      </button>
      <button type="button" class="ghost" (click)="resetForm()">
        <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd"/>
        </svg>
        {{ isEditMode() ? 'Cancelar' : 'Restablecer' }}
      </button>
    </div>

    <p class="feedback" *ngIf="resultMessage()">{{ resultMessage() }}</p>
  </form>
</div>